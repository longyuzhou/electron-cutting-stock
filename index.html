<!doctype html>
<html class="h-100">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="./static/bootstrap.min.css">
  <link rel="stylesheet" href="./static/jquery-confirm.min.css">
  <script src="./static/jquery-3.4.1.slim.min.js"></script>
  <script src="./static/popper.min.js"></script>
  <script src="./static/bootstrap.min.js"></script>
  <script src="./static/jquery-confirm.min.js"></script>
  <script src="./static/vue.min.js"></script>
  <script src="./static/cutting-stock.js"></script>
  <script src="./static/utils.js"></script>
  <title>材料切割</title>
</head>

<body class="h-100" style="padding: 10px 0px;">
  <div id="app" class="container-fluid h-100">
    <div class="row h-100">
      <div class="col-3 h-100 d-flex flex-column">
        <div class="form-group was-validated">
          <label for="material">材料长度</label>
          <input type="number" class="form-control" required min="1" step="any" v-model.number="material">
        </div>
        <div class="form-group was-validated">
          <label for="losses">切割损耗</label>
          <input type="number" class="form-control" min="0" step="any" v-model.number="losses">
        </div>
        <div class="form-group was-validated">
          <label for="orders">订单</label>
          <div class="form-row">
            <div class="col-5">
              <input type="number" class="form-control" placeholder="尺寸" min="1" step="any" id="length" v-model.number="length" v-on:keyup.enter="addOrder">
            </div>
            <div class="col-4">
              <input type="number" class="form-control" placeholder="数量" required min="1" v-model.number="count" v-on:keyup.enter="addOrder">
            </div>
            <div class="col-3">
              <button class="btn btn-primary btn-block" @click="addOrder">添加</button>
            </div>
          </div>
        </div>
        <div class="form-group flex-grow-1 d-flex flex-column overflow-auto">
          <ul class="list-group" id="orders">
            <li class="list-group-item d-flex justify-content-between align-items-center" v-for="order in orders">
              {{ order.length }} &times; {{ order.count }}
              <button type="button" class="btn btn-danger" @click="removeOrder(order.length)">删除</button>
            </li>
          </ul>
        </div>
        <button class="btn btn-primary btn-block" @click="compute">计算</button>
      </div>
      <div class="col h-100">
        <textarea class="form-control h-100" style="font-family: '黑体'; background-color: white;" readonly id="solutions" v-model="solution"></textarea>
      </div>
    </div>
  </div>
  <script>
    const app = new Vue({
      el: '#app',
      data: {
        material: 600,
        losses: 0.1,
        length: null,
        count: 1,
        orders: [],
        solution: ''
      },
      created() {
        this.add(100, 20)
        this.add(190, 20)
        this.add(300, 20)
      },
      watch: {
        material: function(val) {
          if (typeof(val) !== 'number' || val <= 0) {
            this.material = null
          }
        },
        losses: function(val) {
          if (typeof(val) !== 'number' || val < 0) {
            this.losses = null
          }
          if (val === this.material) {
            error('切割损耗等于材料长度')
            this.losses = null
          }
          if (val > this.material) {
            error('切割损耗超出材料长度')
            this.losses = null
          }
        },
        length: function(val) {
          if (typeof(val) !== 'number' || val <= 0) {
            this.length = null
          }
          if (val > this.material) {
            error('尺寸超出材料长度')
            this.length = null
          }
        },
        count: function(val) {
          if (typeof(val) !== 'number' || val <= 0) {
            this.count = null
          }
        }
      },
      methods: {
        add(length, count) {
          if (typeof(length) !== 'number' || length <= 0
            || typeof(count) !== 'number' || count < 1
            || typeof(this.material) !== 'number' || length > this.material) {
            return
          }

          list = this.orders.filter(o => o.length === length)
          if (list.length > 0) {
            list[0].count += count
          } else {
            this.orders.push({ length: length, count: count })
          }
          this.orders.sort((x, y) => x.length - y.length)
        },
        remove(length) {
          for (let i = 0; i < this.orders.length; i++) {
            if (this.orders[i].length === length) {
              this.orders.splice(i, 1)
              return
            }
          }
        },
        addOrder() {
          this.add(this.length, this.count)
          $('#length').focus()
          this.length = null
          this.count = 1
        },
        removeOrder(length) {
          this.remove(length)
        },
        compute() {
          if (typeof(this.material) !== 'number' || this.material <= 0
            || typeof(this.losses) !== 'number' || this.losses < 0
            || this.material < this.losses) {
            return
          }
          this.solution = cut_and_print(this.material, this.losses, this.orders)
        }
      }
    })

    function error(s) {
      $.confirm({
        title: "错误",
        content: s,
        type: "red",
        draggable: false,
        buttons: {
          close: {
            text: "知道了",
            action: function () { }
          }
        }
      });
    }
  </script>
</body>

</html>